% dvips -t letter capuaf_manual.dvi -o capuaf_manual.ps ; ps2pdf capuaf_manual.ps
\documentclass[11pt,titlepage,fleqn]{article}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{latexsym}
\usepackage[round]{natbib}
\usepackage{xspace}
\usepackage{setspace}
\usepackage{graphicx}
\usepackage{fancybox}
\usepackage{url}
\usepackage{color}

\textwidth 17cm
\textheight 23.8cm
\oddsidemargin -4.5mm
\evensidemargin -4.5mm
\topmargin -15mm

\include{carlcommands}

\newcommand{\ux}{\frac{\partial ^2 u}{\partial x^2}}
\newcommand{\uy}{\frac{\partial ^2 u}{\partial y^2}}
\newcommand{\uz}{\frac{\partial ^2 u}{\partial x^2}}
\newcommand{\ut}{\frac{\partial ^2 u}{\partial t^2}}
%\newcommand{\brho}{\mbox{\boldmath $\bf \rho$}}
\newcommand{\nb}{\mbox{$\nu_\beta$}}
\newcommand{\na}{\mbox{$\nu_\alpha$}}

%\newcommand{\angstr}{\Phi}
%\newcommand{\angdip}{\delta}
%\newcommand{\angrak}{\lambda}
\newcommand{\angstr}{\kappa}
\newcommand{\angdip}{\theta}
\newcommand{\angrak}{\sigma}

\newcommand{\bdes}{\begin{description}}
\newcommand{\edes}{\end{description}}
\renewcommand*{\arraystretch}{1.4}

\graphicspath{
{/scratch/vipul/manuscripts/2016/nehrp/figures/cap/}
{/scratch/vipul/manuscripts/2016/nehrp/figures/cap/misfit_tests/}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\begin{spacing}{1.2}
\centering
{\Large \bf User manual for {\tt capuaf}: moment tensor inversion} \\ \medskip
Vipul Silwal, Celso Alvizuri, Carl Tape \\
Geophysical Institute, University of Alaska, Fairbanks, Alaska \\
Last compiled: \today
\end{spacing}
%==================================================================

\vspace{-0.5cm}
\subsection*{Overview}

This code is a modified version of the ``cut-and-paste'' (\verb+cap+) code of \citet{ZhaoHelm1994} and \citet{ZhuHelm1996}. As requested in the \verb+cap+ documentation, any code that modifies \verb+cap+ should use a different name; hence, we refer to our version as \verb+capuaf+. \refTab{tab:pubs} lists publications with results obtained from \verb+capuaf+. Moment tensor catalogs for these studies can be found in Scholarworks collections, as cited from within the published papers.

\medskip\noindent
{\bf WARNING TO USER:} This user manual is a work in progress and is probably not be up-to-date with the latest changes in the code.

\medskip\noindent
{\bf REQUEST FOR FEEDBACK:} If you detect bugs, have suggestions, or have questions, please post an issue on github. (Or email Carl Tape (\verb+ctape@alaska.edu+), who will forward the request to \verb+capuaf+ developers.)

\begin{table}[h]
\centering
\caption[]
{
Summary of studies using {\tt capuaf}.
DC = double couple moment tensors considered.
FMT = full moment tensors considered.
UNC = moment tensor uncertainties estimated.
FMP = first-motion polarities used.
\label{tab:pubs}
}
\begin{tabular}{|l|c|c|c|c|p{7cm}|}
\hline
paper  & DC & FMT & UNC & FMP & notes \\ \hline
\hline
\citet{SilwalTape2016}   & Y  & --  & Y   & -- & numerous comparison tests; confidence curve of \citet{TapeTape2016} \\ \hline
\citet{AlvizuriTape2016} & -- & Y   & (Y) & Y  & misfit function plotted on lune \\ \hline
\citet{Alvizuri2018}     & -- & Y   & Y   & Y  & confidence curve for full moment tensors; probability density functions for moment tensor source type ($vw$ rectangle) \\ \hline
\citet{Silwal2018}       & Y  & --  & --  & Y  & documentation of modified misfit function that includes polarities and also reward/penalty terms \\ \hline
\citet{AlvizuriTape2018} & -- & Y   & Y   & -- & different static time shifts for Love and Rayleigh waves; interpretation in terms of crack-plus-double-couple model \\ \hline
\hline
\citet{Tape2015}         & Y & -- & -- & Y  & Minto Flats fault zone \\ \hline
\citet{Tape1904}         & Y & -- & -- & -- & 2000-02-03 Kaltag earthquake \\ \hline
\citet{Tape2018}         & Y & -- & -- & -- & 2~very-low-frequency earthquakes, 4~earthquakes in Minto Flats fault zone; testing source duration and choice of bandpass \\ \hline
\hline
\end{tabular}
\end{table}

%\section{Examples}
%\cite{SilwalTape2016,AlvizuriTape2016,Silwal2015catalog_SAK,Silwal2015catalog_MFFZ,Alvizuri2015catalog,Alvizuri2017catalog,Alvizuri2018}

%---------------------------------------

\clearpage
\tableofcontents

%---------------------------------------

\section{\cite{ZhaoHelm1994}}

\subsection{Time shift}
{\bf Cross-correlation function}
The relative time shift of the data f(t) from the synthetics g(t) can be estimated with the use of the cross-correlation function:
\eq
C(t) = \frac{\int_{-\infty}^{\infty} f(\tau)g(t+\tau)d\tau}{(\int_{-\infty}^{\infty}f^2(\tau)d\tau \int_{-\infty}^{\infty}g^2(\tau)d\tau )^{1/2}}
\label{cor}
\en
This is the normalized form of $C(t)$.

\subsection{Seismic Moment}
The moment is the ratio of the peak of the amplitude of the data to that of the synthetics
\eq
M_0 = \frac{Max(|f(t)|)}{Max(|g(t)|)}
\label{moment}
\en
% XXX Carl: In what way is this 'the moment'?

\subsection{Misfit}
The error estimation in this earlier version of code involved both L1 and L2 norm. 
\eqa
L1:||f||_1^1 &=& \int_{t1}^{t2} |f(t)| dt \\
L2:||f||_2^2 &=& \int_{t1}^{t2} f^2(t) dt
\ena
in which [t1, t2] is the time interval, in which the seismogram is used. {\bf The L1 norm emphasizes the high frequencies of the data, whereas the L2 emphasizes the low frequency}.
Using \refEq{moment}, the synthetics are defined as
\eq
d(t) = M_0 g(t)
\label{data}
\en
The error is defined as (using either L1 or L2 norm)
\eq
e_{Lk} = \frac{||f - d||_k}{(||f||_k \times||d||_k)^{1/2}}
\en
Finally the error are implemented in the following manner:
\eq
e_1 = \frac{(e_{L1} + e_{L2} + (2e_{L1}^2 + 2e_{L2}^2)^{1/2})}{4}
\label{misfit1}
\en

For one station $e_2$ is defined the same way as $e_1$, except that the $M_0$ used in the equation \ref{data} is the average moment $(1/n\sum_1^n M_0)$ of all the components used from the station. $e_2$ is a measure of the consistency of all components of one station, i.e. a minimum of $e_2$ gives closest ratios of the different components, say $SH/P_nl$ of the synthetics to data. {\bf In short, $e_1$ emphasizes the fit of the individual components, whereas $e_2$ emphasizes the consistency of all the components of one station}.

In the equation \ref{misfit1} equal weights have been given to the low frequency and high frequency components of the data.

The best solution is obtained by conducting the grid search in strike, dip and rake space, and finding the minimum of:
\eq
SOL: \min(E) = \frac{1}{n} \sum_{i=1}^{n} (e_{1i} + e_{2i})
\en

%----------------------------------------------------------------------
\section{\cite{ZhuHelm1996}}

The equations used in this paper are implemented in CAP. In this section, we copy text excerpts from \citet{ZhuHelm1996}.

\subsection{Misfit}

We define an object function to measure the misfit error between u and s and search through the parameter space to find the global minimum of the object function.
Misfit error is defined as the norm-$k$ (L1 or L2) of the difference between u and s normalized by the norms of both u and s.
\eq
e= \frac{||u-s||_k}{||u||_k \times ||s||_k}
\en

Because Pnl usually has smaller amplitude than surface waves, this normalization helps to weight Pnl and surface waves equally. It also prevents the inversion from being completely dominated by the strongest station, which is usually the nearest station, if several stations at different distance ranges are used. However, the amplitude information is lost during the normalization. Some of this information, such as amplitude ratios of Pnl-to-surface waves and SV-to-SH, provide important constraints on the source orientation and depth. A more severe problem with this normalization is that it introduces singularities in the source parameter space at those points where source orientation generates nodal synthetics (where the norm of synthetics vanishes). In the case when the data include nodal records, the grid search will miss the true minimum.

The misfit error using true amplitudes without normalization:
\eq
e= {||u-s||_k}
\en

\subsection{Distance scaling factor}

Using true-amplitude waveforms for source inversion usually leads to the problem of the closest station dominating the inversion when stations are distributed over a large distance range.

The misfits of surface waves have larger scatter than body waves, which are expected because surface waves are more easily affected by shallow heterogeneity. It has been shown that Pnl at a range of 300 to 1000 km is quite stable (Helmberger and Engen, 1980) and easily inverted for source mechanisms (Wallace and Helmberger, 1982). At closer range, the details of the Moho transition plays a more important role as well as the PL waves trapped in the shallow crust (Song and Helmberger, 1996). Since both of these features show strong local variation, we should expect the large scatter.

The misfit errors show a rapid decay with distance. Since radiation patterns have been taken out, this decay is related to the amplitude decay due to geometrical spreading and attenuation. To compensate for this decay, we introduce a distance range scaling factor and define the misfit error for a record at a distance r as:
\eq
\boxed{
e =  \left ( \frac{r}{r_0} \right)^p  || u-s||_k
}
\label{misfit_func}
\en

There p is a scaling factor to give the record at r the same weight as that at reference distance $r0=100$. Any kind of norm-$k$ {\bf L1 or L2} can be chosen for calculating the data misfit. 

If we assume a spherical geometrical spreading for body waves and cylindrical geometrical spreading for surface waves, an appropriate choice of p would be p=1 for body waves and p=0.5 for surface waves.

%----------------------------------------------------------------
\pagebreak
\section{Implementation: CAP}

The same misfit function as equation \ref{misfit_func} is used and the {\bf L2 norm} is chosen.

\subsection{Distance weighting factor}

First the distance weighting factor is computed
\eq
\mu = \left( \frac{r}{r_0} \right)^p
\en
where r is the distance and $r_0 = 100$~km is the reference distance. Usually $p=1$ for body waves and $p=0.5$ for surface waves.
\eqa
\mu_{pnl} &=& \left( \frac{r}{r_0} \right)^1\\
\mu_{surf} &=& \left( \frac{r}{r_0} \right)^{0.5}
\ena

At this point body and surface wave weight are imposed to evaluate the overall weighting factor
\eqa
w_{pnl}  &=& (\mu_{pnl})\times weight_{pnl}\\
w_{surf} &=& (\mu_{surf})\times weight_{surf}
\ena
%
This weight is given in the input cap command and not the weight file.

We can examine how the parameters $p$ and $r_0$ will influence the amplitudes of the waveforms used in the moment tensor inversions. Note that $\ln(A/B)$ provides a fractional difference bewteen positive quantities $A$ and $B$.
%
\begin{eqnarray*}
A_{corr}(r) &=& A_{raw}(r) \left( \frac{r}{r_0} \right)^p
\\
\frac{A_{corr}(r)}{A_{raw}(r)} &=& \left( \frac{r}{r_0} \right)^p
\\
\ln \left(\frac{A_{corr}(r)}{A_{raw}(r)} \right) &=& \ln \left( \frac{r}{r_0} \right)^p
= p \, \ln \left( \frac{r}{r_0} \right)
\end{eqnarray*}
%
\begin{enumerate}
\item For distant stations ($r > r_0$):\\
$p > 0$ will increase the amplitude\\
$p < 0$ will decrease the amplitude

\item For nearby stations ($r < r_0$):\\
$p > 0$ will decrease the amplitude\\
$p < 0$ will increase the amplitude

\item In CAP $r_0$ = 100 km.
%Most probably reference distance is chosen as 100 km because its easier to take the square root ! (= 10 km).
\end{enumerate}

\subsection{L2 norm of data and green's function}

Before computing the norm, both the data and the green's function are subjected to the weighting factor:
\eqa
u(t)_i &=& w_i\times[f(t)_i];\,\,\,\,\,\,\,\,\,\,i=[Pnl, Surf]\\
s(t)_i &=& w_i\times[g(t)_i];\,\,\,\,\,\,\,\,\,\,i=[Pnl, Surf]
\ena
here f(t) is the recorded seismogram and g(t) is the green's function. Individual components of the data and green's function are picked and then multiplied with the suitable weighting factor depending it is the Pnl of Surface wave section. Each component (R,T,Z) of seismograms is chopped into Pnl and Surface wave section.

Example for a particular station:
\eqa
\left [u(t)_{pnl}\right ]_R &=& w_{pnl} \times \left [f(t)_{pnl} \right]_Z\\
\left [u(t)_{pnl}\right ]_Z &=& w_{pnl} \times \left [f(t)_{pnl} \right]_Z\\
\left [u(t)_{surf}\right ]_R &=& w_{surf} \times \left [f(t)_{surf} \right]_R\\
\left [u(t)_{surf}\right ]_Z &=& w_{surf} \times \left [f(t)_{surf} \right]_Z\\
\left [u(t)_{surf}\right ]_T &=& w_{surf} \times \left [f(t)_{surf} \right]_T
\ena

\subsubsection{L2 norm}
\eqa
L2:||u||^2 &=& \int_{t1}^{t2}u^2(t)dt\\
L2:||s||^2 &=& \int_{t1}^{t2}s^2(t)dt
\label{l2}
\ena
For a vector signal, it is the inner product of the vector with itself.
\eqa
L2:||\bu||^2 &=& \bu^T \bu \\
L2:||\bs||^2 &=& \bs^T \bs
\ena

\subsection{Cross Correlation}
The normalized cross correlation function between u and s are computed using the same as \refEq{cor}. 
\eqa
C(t) &=& \frac{\int_{-\infty}^{\infty} u(\xi)s(\xi-t)d\xi}{(||u||^2 \, ||s||^2)^{1/2}}\\
&=& \frac{(u \star s)(t)} {(||u||^2 \, ||s||^2)^{1/2}}
\ena
This correlation function is the correlation between data and green's function. This is the normalized correlation function (or the {\bf correlation coefficient} whose value is between 0 and 1. For find the actual actual correlation between two function (unnormalized):
\eqa
C(t) &=& (u \star s)(t)\\
&=& \int_{-\infty}^{\infty} u(\xi)s(\xi-t)d\xi
\ena
This is like convolution in some sense. To find the correlation of two functions, one function is slid over the another function.
At some particular value of time $\tau_{max}$ this function $C(t)$ will have it maximum. This maximum correlation point is what we are interested inn matching the wave forms. And the shift $\tau_{max}$ is the relative shift between synthetics and data.
\eqa
C_{max} = C(\tau_{max}) &=& \max\left [corr(u(t),s(t)) \right]\\
&=& \max \left [(u \star s)(t) \right]\\
&=&\max \left [\int_{-\infty}^{\infty} u(\xi)s(\xi-t)d\xi \right]\\
&=& \int_{-\infty}^{\infty} u(\xi)s(\xi-\tau_{max})d\xi\\
&=& \max\left [(u \star s)(\tau_{max}) \right]
\label{cor_max}
\ena
Thus for the maximum correlation of two functions $u(t)$ and $s(t)$, we are multiplying the functions are shifting the synthetics by $\tau_{max}$ and then finding area under the curve $u(t)s(t+\tau_{max})$.


\subsection{Moment magnitude}
 $M_0$, the is seismic moment $M_0 = \mu A D$, where $\mu$ is the shear modulus, $A$ is the area of rupture and $D$ is the average displacement. Relationship between moment magnitude $M_w$ and seismic moment $M_0$ is given by \cite{Kanamori1977} relation,:
\eq
M_w = \frac{2}{3}(\log_{10}M_0) + k'
\en
Actual numbers are cited in Hanks and Kanamori 1979
GCMT catalog, \cite{AkiRichardsE1}, and \cite{ShearerE1} uses the following equation:
\eq
M_w = \frac{2}{3}(\log_{10}M_0) - \frac{2}{3}(16.1)
\en
However in the actual code, CAP uses the following equation to estimate the scaled seismic moment $A$ from moment magnitude $M_w$ :
\eqa
M_w &=& \frac{2}{3}(\log_{10}(A)) + \frac{2}{3}(20 -16.1)\\
A &=& 10^{(1.5M_w +16.1 - 20)}
\ena
To relate $M_0$ and A:
\eqa
M_w &=& \frac{2}{3}(\log_{10}(A)) + \frac{2}{3}(20 -16.1)\\
&=& \frac{2}{3}(\log_{10}(A) + 20) - \frac{2}{3}16.1\\
\mbox{Therefore}\\
(\log_{10}(A) + 20) &=& \log_{10}M_0\\
\log_{10}\frac{M_0}{A} &=& 20\\
\frac{M_0}{A} &=& 10^{20}\\
A &=& \frac{M_0}{10^{20}}
\ena
P.S. Instead of $M_0$, $A$ will be used to obtain the scaled moment tensor elements. 

\subsection{Source duration}
Use -L flag. CAP now outputs the source function file (see OUTPUT\_DIR/srcfile). 
The source function a trapezoidal function with rise\_time = $0.5 \times$ source duration ($\Delta t$)
\eq
\Delta t = (int) 10^{\frac{(Mw - 5)}{2} + 0.5}
\en
For positive real numbers (int) function in perl is same as floor function of MATLAB, \ie rounds towards zero. 

Then it puts some sanity constrains so that duration do not exceed [1,9] seconds. Use -L flag for manual source duration length. See \refFig{fig:cap_dur} for variation of source duration with magnitude. 

CAUTION: Using a wrong source duration can cause error in magnitude estimates. This become extremely crucial for small magnitude events. Smaller source duration (-L) will underestimate the magnitude and larger source duration will overestimate the magnitude.
\begin{verbatim}
  $dura = 1 if $dura < 1;
  $dura = 9 if $dura > 9;
\end{verbatim}


\subsection{Fault plane solution to Moment tensor}
\eqa
M_{xx} &=& -(\sin \angdip\, \cos \angrak\, \sin 2\angstr + \sin 2\angdip \,\sin \angrak\, \sin^2\angstr)\\
M_{yy} &=& (\sin \angdip\, \cos \angrak\, \sin 2\angstr - \sin 2\angdip\, \sin \angrak\, \cos^2\angstr)\\
M_{zz} &=& (\sin 2\angdip\, \cos \angrak)\\
M_{xy} &=& (\sin \angdip\, \cos \angrak\, \sin 2\angstr + 0.5 \sin 2\angdip\, \sin \angrak\, \sin2\angstr)\\
M_{xz} &=& -(\cos \angdip\, \cos \angrak\, \cos \angstr + \cos 2\angdip\, \sin \angrak\, \sin\angstr)\\
M_{yz} &=& -(\cos \angdip\, \cos \angrak\, \sin \angstr - \cos 2\angdip\, \sin \angrak\, \cos\angstr)
\ena
\bdes
\item $\angstr$, strike of the fault
\item $\angdip$, dip angle of the fault plane
\item $\angrak$, slip angle
\edes

\subsection{Green's function to Synthetics}
When conducting the grid search over strike, dip and rake, the moment tensor is evaluated. Using this moment tensor and the azimuth of the station, the radiation pattern ({\bf horizontal radiation coefficient}) are found. See \cite{JostHerrmann1989}.

\eqa
A1 &=& -\frac{1}{2}(M_{xx} - M_{yy})\cos(2az) + M_{xy}\sin(2az)\\
A2 &=& -M_{xz}\cos(az) - M_{yz}\sin(az)\\
A3 &=& \frac{2M_{zz} - M_{yy} - M_{xx}}{6}\\
A4 &=& -\frac{1}{2}(M_{xx} - M_{yy})\sin(2az) + M_{xy}\cos(2az)\\
A5 &=& -M_{yz}\sin(az) + M_{xz}\sin(az)\\
A6 &=& 0\\
A7 &=& \frac{M_{zz} + M_{yy} + M_{xx}}{3}\\
A8 &=& 0
\ena
To find the actual synthetics, these need to be multiplied by the scaled seismic moment $A$. \\
$\bA = A * [A1\, A2\, A3\, A4\, A5\, A6\, A7\, A8]$.

The synthetics can be computed using the 9 green's functions and these 6 radiation coefficients:
\eqa
d_z &=& ZSS\,\, A1 + ZDS\,\, A2 + ZDD\,\, A3 +ZEP\,\, A7\\
d_r &=& RSS\,\, A1 + RDS\,\, A2 + RDD\,\, A3 +REP\,\, A7\\
d_t &=& TSS\,\, A4 + TDS\,\, A5 + TDD\,\, A6 +TEP\,\, A8
\label{syn}
\ena
where R,T,Z are radial, transverse and vertical components of SS(vertical strike-slip), DS(vertical dip-slip) and DD($45^o$ dip-slip). 

P.S. No Transverse components from vertical dip-slip fault and explosive source (TDD and TEP are 0)

WARNING: The above information may be inaccurate (?).  For double-couple searches, there appear to be 5 unique coefficients and 8 Green's functions.  For general moment tensor searches there appear to be 6 unique coefficients and 10 Green's functions.  If these details are important to you, please double check the source code yourself to be sure. -Ryan

\subsubsection{time shift}
However instead of using the green's function the correlation function $C(t)$ is used. Correlation between the data and corresponding green's function. (i.e. instead of green's function ZSS, the correlation of ZSS and vertical component of data is used.
\eqa
v_z &=& corr(ZSS,u_z)\,\, A1 + corr(ZDS,u_z)\,\, A2 + corr(ZDD,u_z)\,\, A3 + corr(ZEP,u_z)\,\, A7\\
v_r &=& corr(RSS,u_r)\,\, A1 + corr(RDS,u_r)\,\, A2 + corr(RDD,u_r)\,\, A3 + corr(REP,u_r)\,\, A7\\
v_t &=& corr(TSS,u_t)\,\, A4 + corr(TDS,u_t)\,\, A5 + corr(TDD,u_t)\,\, A6 + corr(TEP,u_t)\,\, A8
\ena
where $v_z,v_r,v_t$ are correlation of data and synthetics for a particular component. The value of time for which this correlation value comes out to be maximum, is the corresponding time\_shift($\tau$) for that component.\\
{\bf Pnl wave} (time\_shift = $\tau1$)
\eqa
P_z &=& corr(ZSS,u_z)\,\, A1 + corr(ZDS,u_z)\,\, A2 + corr(ZDD,u_z)\,\, A3 + corr(ZEP,u_z)\,\, A7\\
P_r &=& corr(RSS,u_r)\,\, A1 + corr(RDS,u_r)\,\, A2 + corr(RDD,u_r)\,\, A3 + corr(REP,u_r)\,\, A7\\
P_{max} &=& \max(w1 \cdot P_z+w2 \cdot P_r)_{\tau1}
\ena
{\bf Rayleigh wave} (time\_shift = $\tau2$)
\eqa
S_z &=& corr(ZSS,u_z)\,\, A1 + corr(ZDS,u_z)\,\, A2 + corr(ZDD,u_z)\,\, A3 + corr(ZEP,u_z)\,\, A7\\
S_r &=& corr(RSS,u_r)\,\, A1 + corr(RDS,u_r)\,\, A2 + corr(RDD,u_r)\,\, A3 + corr(REP,u_r)\,\, A7\\
S_{max} &=& \max(w3 \cdot S_z+w4 \cdot S_r)_{\tau2}
\ena
{\bf SH wave} (time\_shift = $\tau3$)
\eqa
L_t &=& corr(TSS,u_t)\,\, A4 + corr(TDS,u_t)\,\, A5 \\
L_{max} &=& \max(w5 \cdot L_t)_{\tau3}
\ena
where w1 to w5 are the weights for particular component (as specified in the weight file).

\subsubsection{New synthetics}
After finding the point of maximum correlation, and shifting the synthetics, we obtain new synthetics of the form:
\eq
s'(t) = s(t-\tau)\\
\en
The negative sign is used because positive time shift means, synthetics is earlier and needs to be shifted in positive $t$ direction. In vector form :
\eqa
\mbox{old synthetics}:& s(t) &= \bs\\
\mbox{new synthetics}:& s'(t) &= \bs'\\
\mbox{relationship}:& s'(t) &= s(t-\tau)
\ena

\subsection{L2 norm synthetics}
Compute synthetics as in \refEq{syn} and find the L2 norm using the same formula as \refEq{l2}. 
\eqa
s_z &=& ZSS\,\, A1 + ZDS\,\, A2 + ZDD\,\, A3 +ZEP\,\, A7\\
s_r &=& RSS\,\, A1 + RDS\,\, A2 + RDD\,\, A3 +REP\,\, A7\\
s_t &=& TSS\,\, A4 + TDS\,\, A5 
\ena
L2 norm
\eqa
||s||^2 &=& \int_{t1}^{t2}s^2(t)dt\\
&=& \int_{t1}^{t2}s'^2(t)dt\\
&=& \int_{t1+\tau}^{t2+\tau}s^2(t-\tau)dt\\
&=& (\bs^T) (\bs)\\
&=& (\bs'^T) (\bs')
\ena


\subsection{Correlation between data and synthetics}
The correlation between data $u(t)$ and synthetics $s'(t) = s(t-\tau)$ (new synthetics shifted by $\tau$ which gives maximum correlation), can be found by using \refEq{cor_max}
\eqa
corr(u(t),s(t))_{max}= C_{max}=C(\tau_{max}) &=& \int_{t1}^{t2} u(t)s(t- \tau_{max})dt\\
&=& \int_{t1}^{t2} u(t)s'(t)dt\\
&=& (u \star s)(\tau_{max})
\ena

\subsection{Misfit}
Finally the misfit $e$ is given by:
\eq
\mbox{Integral form:   } e = \int_{t1}^{t2}u^2(t)dt + \int_{t1}^{t2}s^2(t)dt - 2\int_{t1}^{t2} u(t)s(t- \tau_{max})dt
\en
replacing $s(t)$ by shifted synthetics $s'(t)$
\eqa
 e &=& \int_{t1}^{t2}u^2(t)dt + \int_{t1}^{t2}s'^2(t)dt - 2\int_{t1}^{t2} u(t)s'(t)dt\\
 &=& \int_{t1}^{t2}(u^2(t) + s'^2(t) - 2 u(t)s'(t))dt\\
 &=& \int_{t1}^{t2}(u(t)-  s'(t))^2dt\\
\mbox{Vector form:   } e&=& (\underline{\bu}^T) (\underline{\bu})+ (\underline{\bs}'^T) (\underline{\bs}') - 2\,(\underline{\bu}^T) (\underline{\bs}')\\ 
&=& (\underline{\bu} - \underline{\bs}')^T(\underline{\bu} - \underline{\bs}')
% \mbox{Algebaric form:   } e &=& ||u||^2 + ||s||^2 - 2\, corr(u(t),s(t))_{max}\\
% &=&  ||u||^2 + ||s||^2 - 2\, ||u \cdot s||_{\tau}\\
% &=& ||u - s||^2_{\tau}
\ena
This is the misfit error for a particular component of a particular station. 
\bdes
\item $u(t) \equiv \bu $, is the recorded data (Pnl or Surface wave window)
\item $s(t) \equiv \bs $, is the synthetic seismograms (Pnl or Surface wave window)
\item $s'(t - \tau) \equiv \bs' $, is the synthetic seismograms shifted by $\tau$  to maximum correlation point (Pnl or Surface wave window)
\edes

For all N stations and all components:
\eqa
E = \sum_{j=1}^N \sum_{i=1}^5e_{ij} &=& \sum_{j=1}^N \sum_{i=1}^5 w_{ij} (\underline{\bu}_{ij} - \underline{\bs}'_{ij})^T(\underline{\bu}_{ij} - \underline{\bs}'_{ij})\\
 &=& \sum_{j=1}^N \sum_{i=1}^5  (\underline{\bu}_{ij} - \underline{\bs}'_{ij})^T\bW_{ij}(\underline{\bu}_{ij} - \underline{\bs}'_{ij})
\ena
where $w_{ij}$ is the weight for $i^{th}$ component at the $j^{th}$ station. Since our data $\bu_{ij}$ and synthetics $\bs'_{ij}$ are vectors, $\bW_{ij} = \bI\,w_{ij}$. Dimensions of $\bI$ are number of sample points in the corresponding time window.

The misfit is {\bf not} normalized over number of stations or components.

This objective function $E$ is minimized. The another way of looking at this is:
\eqa
SOL: \min(E) &=& \min( ||u||^2 + ||s||^2 - 2\, corr(u(t),s(t)))\\
&=& ||u||^2 + ||s||^2 - \max(2\, corr(u(t),s(t)))\\
&=& ||u||^2 + ||s||^2 - 2\max[(u \star s)(t)]\\
%\mbox{replacing by shifted synthetics}&&\\
&=& ||u||^2 + ||s||^2 - 2[(u \star s)(\tau_{max})]
\ena

\subsection{Correlation percentage}
Cross-correlation coefficient are computed using the normalized form. For a particular component, the correlation percentage is computed as follows:
\eqa
cp_i &=& 100 * \left(\frac{\max[corr(u(t),s(t))]}{\sqrt{||u||^2  \, ||s||^2}} \right)\\
%&=&  100 * \frac{(||u\cdot s||)_{\tau}}{\sqrt{||u||^2 \cdot ||s||^2}}
&=&  100 * \left(\frac{(u \star s)(\tau_{max})}{\sqrt{||u||^2 \, ||s||^2}} \right)
\ena
could be simplified to:
\eq
cfg= 100 * \left(\frac{||u-s||^2}{\sqrt{||u||^2 \, ||s||^2}} \right)
\en

\subsection{Variance reduction}
Variance reduction is defined as improvement in the solution from some standard reference. In this case, the standard reference is when synthetics $s(t)=0$ (no valid reason for assuming this). At $s(t)=0$, the Variance Reduction $VR=0$. And if our synthetics $s(t)$ perfectly matches the data  $u(t)$, i.e.  $s(t)=u(t)$, the $VR=100$.
\eqa
VR &=& 100 * \left (1 - \frac{E}{||u||^2} \right )\\
&=& 100 * \left (1 - \frac{||u-s||^2}{||u||^2} \right )
\ena
Dreger uses different Variance reduction formula,
\eq
VR = 100 * \left (1 - \frac{\sqrt{||u-s||^2}}{\sqrt{||u||^2}} \right )
\en
For an acceptable solution, variance reduction is usually greater than 70\%.

\subsection{Depth Test}

To obtain the best depth solution, inversion is performed at different depths and the minimum is found. To further get a better estimate, the minimum of the best fitting parabola is used.

However, for error-depth plot, a different measure is taken instead of misfit error, and then plotted against depth.
\eq
E\% = f \times \left ( \frac{E_d}{E_{min}} -1 \right )
\en
\bdes
\item $E\%$, quantifying the error of depth $d$ w.r.t. to error at best depth
\item $f$, degree of freedom where $f = n (N_{samp})$, where $n$ is number of freedom per sample and $N_{samp}$ is the total number of sampling points used for inversion (All stations body and surface waves). 
\item $E_d$, error at depth $d$ 
\item $E_{min}$, error at best depth $E_{min} = \min(E_d)$
\edes
The default value of degree of freedom per sample $n =0.01$. Changing this by order of 10, we can also control the steepness of the depth curve.

%------------------------------------------------

\section{Changes made to CAP by UAF group}

\subsection{Changes in grid search}

Uniform orientations provide a homogeneous distribution of double couple moment tensors. To achieve this, we use the coordinate $h = \cos\angdip$ instead of dip angle $\angdip$ \citep{TapeTape2012beach}.
%we sample the parameters homogeneously in their cosine space, and then use the arccosine of those equally spaced value. Subsequently, it appears that spacing is larger near equator ($\angdip$=0 and densely sampled near the pole ($\angdip$=90).

\bdes
\item $\angdip_0$, first element of search range in dip
\item $\Delta\angdip_d$, search increment
\item $N$, number of samples to be generated
\item $\angdip_1 = \angdip_0 + (N-1)\Delta\angdip_d$, would be the final element of search range in dip
\edes

Then
\eq
\angdip_i = \cos^{-1}\left ({\cos(\angdip_0)}
- i \left[ \frac{\cos(\angdip_0 - \cos\angdip_1)}{N}\right] \right)
\en

For the full moment tensor grid search, to obtain uniform spacing of points on the lune, we perform a similar transformation for the lune longitude $\delta$:
\eq
\delta_i = \sin^{-1}\left ({\sin(\delta_0)}
+ i \left[ \frac{\sin(\delta_1 - \sin\delta_0)}{N}\right] \right)
\en

\subsection{Changes in misfit function}

\begin{enumerate}
\item Normalized the misfit error by number of components used. Error may now actually decrease by addition of `good' stations.
{\bf normalization method}
\eq
||E_1(\bem)||_2^2 = \frac{1}{(P_{comp}+S_{comp})} \left [ \sum_{i=1}^{P_{comp}} \frac{\int W_i||(\bu_p)_i - (\bs_p)_i||_2^2 dt}{(N_p)_i} + \sum_{i=1}^{S_{comp}} \frac{\int W_i||(\bu_s)_i - (\bs_s)_i||_2^2 dt}{(N_s)_i} \right ]
\en
\bdes
\item $\bem$, Model parameters (Strike $\angstr$,Dip $\angdip$,Rake $\angrak$)
\item $u_p$, observed P waveform
\item $P_{comp}$, number of P components used
\item $(N_p)_i$, number of sampling points for P (may vary from station to station)
\item $u_s$, observed S waveform
\item $S_{comp}$, number of S components used
\item $(N_s)_i$, number of sampling points for S (may vary from station to station)
\item $W_i$, weight given to that particular waveform
\edes
This equation can be simplified to following form:
\eq
||E_1(\bem)||_2^2 = \frac{\sum_{i=1}^{N_{comp}}(\bu_i - \bs_i)^t(\frac{W_i}{N_i})(\bu_i - \bs_i)}{N_{comp}}
\en
where,
\bdes
\item $\bu_i$, observed waveform (body or surface wave)
\item $\bs_i$, synthetic waveform (body or surface wave)
\item $N_{comp}$, number of components used (all body and surface waveforms)
\item $N_i$, number of sampling points for the waveform (may vary from station to station)
\item $W_i$, weight given to that particular waveform
\edes

Normalized misfit could be written as:
\eq
||E_r(\bem)||_2^2 = \frac{\sum_{i=1}^{N_{comp}}(\bu_i - \bs_i)^t(\frac{W_i}{N_i})(\bu_i - \bs_i)}{\sum_{i=1}^{N_{comp}}(\bu)^t(\frac{W_i}{N_i})(\bu)}
\en
This is useful when we are comparing across different events. Other common names in the literature for this normalized or reduced misfit is `reduced chi-square'. $\chi^2$ could be converted to variance reduction (which have many different formulas in literature).
\eqa
V.R. &=& (1 - ||E_r(\bem)||_2^2) \times 100\\
&=& (1 - ||E_r(\bem)||_2) \times 100\\
&=& \ln \left (\frac{||E_1(\bem)||^2_2}{||d||^2_2} \right) \times 100\\
&=& \ln \left (\frac{||E_1(\bem)||_2}{||d||_2} \right) \times 100
\ena
Since variation reduction is only good for comparing 
\item If higher weight is given to a good station whose waveform is matching well (higher correlation value), then overall misfit value reduces. vice versa, if higher weight is given to a bad station whose waveform is not matching well (low correlation value), then overall misfit value increases.
\end{enumerate}

%--------------------------------------------------------------------

\section {Creating posterior samples \citep{SilwalTape2016}}

Our misfit function needs to be modified because of two following reasons:
\begin{enumerate}
\item Low misfit value\\
This basically is because of small amplitudes in displacement and velocity field of seismograms, hence also in L2 norm of data, synthetics and misfit. One common way of overcoming this is by normalizing it with data norm, but this leads to giving high weight in case of nodal stations \citep{ZhuHelm1996}. Another way to get around this is dividing the misfit function by its minimum value and measuring its logarithmic variation.
\eq
\ln \left ( \frac{E}{E_{min}} \right )
\en
\item Another issue is with misfit function being too smooth. Possible reasons for this could be :
\begin{enumerate}
\item Not using the proper parameterization for moment tensor inversion \citep{TapeTape2012beach}. 
\item Smooth misfit function also arises because of using exact magnitude $M_w$ and not using full 6-parameter space for generating posterior samples. Our misfit function has only 3 model parameter (strike,dip,rake).
\end{enumerate}
To overcome this we scale the misfit by:
\eq
\frac{T}{\ln \left (\frac{E_{max}}{E_{min}}\right)}
\en
\end{enumerate}
Our final misfit function which is used for creating posterior pdf is:
\eq
E_2(\bem)=E(\angstr,\angdip,\angrak) = \frac{\ln \left ( \frac{E}{E_{min}} \right )}{\ln \left (\frac{E_{max}}{E_{min}} \right)} \times T
\label{err4prob}
\en
where $T$ is any multiplication factor. This $T$ could be thought of as temperature in the energy function for {\it simulated annealing}.

%------------------------------------------
\subsection{Misfit function to posterior probability density function}
See \cite{SilwalTape2016,TapeTape2016}
\iffalse
XXX: THIS SECTION NEEDS TO BE UPDATED (SEE SilwalTape2016) \\ 
The scaled logarithmic variation Eq.\ref{err4prob} of misfit could be used to get the posterior probability of solution in model space. 
\eq
\sigma(\bem) = \frac {\exp \left (-E_2(\bem) \right )}{k}
\en
where $k = \int \exp (-E_2(\bem)\ d\bem$ is the normalization factor and $\bem$ are our model parameters ($\angstr,\angdip,\angrak$). $\bsigma(\bem)$ is the posterior probability density function. However, this is does not include any knowledge of the {\it shape} of the space in itself, \ie the information about the homogeneous probability of model space parameters. \citep{Tarantola2006}. To get 'the' solution, homogeneous state of information ($\bmu(\bem)$) must be introduced in order to achieve the actual likelihood of solution. This could be done by:
\eq
L(\bem)=\frac{\bsigma(\bem)}{\bmu(\bem)}
\en
In case of double couple, homogeneous state of information $\bmu(\bem) = \bmu(\angstr,\angdip,\angrak)$ is given by:
\eqa
\mu(\angstr) &=& c_1\\
\mu(\angdip) &=& \cos^{-1}c_2\\
\mu(\angrak) &=& c_3
\ena
where $c_1, c_2$ and $c_3$ are constants.
The importance of likelihood function is that it is the ratio of probabilities (not the probability in itself) which makes it invariant of transformation of variables. A property similar to volumetric probability $V(\bem)$.

For a double couple source, the shape of beachball always remains the same. What changes is the orientation of it. Keeping this in mind, it would be more sensible to estimate the uncertainty in terms of rotation of beachball from its minimum misfit (maximum likelihood) orientation rather that separately evaluating the uncertainties for different parameters (whether strike-dip-rake or moment-tensors elements). Also we can't do this in strike-dip-rake space because of the complications of clearly defining the domain. Parameterization would definitely have a great impact on uncertainty estimation. Here even though we are only using one rotation angle (minimum), in reality we should using the whole rotation matrix in order to clearly understand and quantify the misfit variation in parameter space.

We transform our parameter space from ($\angstr,\angdip,\angrak$) to ($\omega$ or $\xi$). 

Let the orientation of minimum misfit solution be $\bem_0 = {\angstr_0, \angdip_0, \angrak_0}$. Distance between all the samples, $\bem$, and minimum misfit solution $\bem_0$ can be written as:
\eq
[\bem, \bem_0] = \bxi
\en
This is an example of surjective mapping (not injective). There are four different angles in quaternion space that make this rotation possible (\cite{Kagan1991}, \cite{TapeTape2012c_kagan}). If we only take the minimum angle of rotation required for this transformation, the mapping becomes injective.

Using this transformation, we can find $\sigma'(\bxi)$ from $\sigma(\bem)$. However, they are not the same (due the transformation of variables). What still remains same is the likelihood function. Mathematically, we can write
\eqa
\sigma(\bem) &\neq& \sigma'(\bxi)\,\,\,\,\,\,\,\,\,\,\,\,\,\,\,\, \left [\because \sigma'(\bxi) = \sigma(\bem)\left | \frac{d \bxi}{d \bem} \right | \right ]\\
\frac{\sigma(\bem)}{\mu(\bem)} &=& \frac{\sigma'(\bxi)}{\mu'(\bxi)}\\
L(\bem)&=& L'(\bxi)
\ena
\fi

\pagebreak
\section{Combining polarity and waveform misfi \citep{Silwal2018}}
\cite{Zahradnik2015} - We are NOT using the same approach. They used polarity as a constraint and searched for the possible solution  \\
-X flag specifies the weight for combining polarity and waveform misfit.

For example, If the polarity weight is $\omega$, \ie \ -X$\omega$
\begin{align*}
polarity\_weight &= \omega \\
waveform\_weight &= 1 - \omega \\
polarity\_error, \phi_{pol} &= \omega \times \frac{N_p}{N}\\
waveform\_error, \phi_{wf} &= [SAME\ AS\ BEFORE] \\
total\_misfit, \Phi &= \phi_{pol} + (1 - \omega) \cdot \phi_{wf}
\end{align*}

See \refFig{fig:pol_weight} to see the effect of increasing the polarity weight on the obtained minimum total misfit solution.

Waveform error is not changed so that:
\begin{enumerate}
\item One can still use the post-processing scripts (MATLAB, perl). The waveform error and polarity misfit (number of stations at which polarity is not matching) are also saved in the binary files. If we make the change here then we have to make sure to make changes in other scripts. 
% This would entail (a) remove the total\_misft.m section from MATLAB scripts (b). Correct K factor is being chosen
%\item {\bf VR estimation is based on waveform misfit and not total misfit. } This means VR in the new CAP is going to same as in old CAP. Maximum VR is NOT the best solution! Minimum total misfit IS the best solution.
\end{enumerate}

\subsubsection*{Possible way of computing VR}
{\bf Option 1} This didn't work out
\begin{align*}
VR_{wf} &= 100 \times \left( 1 - \left (\frac{\phi_{wf}}{u} \right)^2 \right) \\
VR_{pol} &= 100 \times \left( 1 - \left ( \frac{N_p}{N} \right) ^2 \right ) \\
VR &=  \omega \cdot VR_{pol} + (1 - \omega) \cdot VR_{wf}
\end{align*}

\fbox{
\begin{minipage}{35em}
{\bf Option 2:} This one is currently under testing and seems to work, and it is much cleaner too:
\begin{align*}
total\_misfit, \Phi &= \phi_{pol} + (1 - \omega) \cdot \phi_{wf}\\
VR &= 100. \times (1 - \Phi^2)
\end{align*}
\end{minipage}
}

Here is how it looks in the code (sub\_inversion.c):
\subsubsection*{waveform misfit}
\begin{verbatim}
// waveform misfit
sol = get_tshift_corr_misfit(nda,obs0,max_shft,tie,norm,mtensor,amp,sol);
sol.wferr = sol.wferr/Ncomp;    // Ncomp = number of components.
sol.wferr = sol.wferr/data2;    // normalize by data

//---------------- combine polarity and waveform misfit---------------------------
// If -X flag is specified sol.err will contain the total misfit
 if ((int)pol_wt != 999){
     misfit_pol_weight = pol_wt; // this should come as an input from cap.pl (-X flag)
     misfit_wf_weight = 1 - misfit_pol_weight;
     sol.polerr = (float)misfit_pol_weight * misfit_fmp/nfm;
     sol.err = sol.polerr + misfit_wf_weight * sol.wferr;
     //fprintf(stderr,"---> %f %f %f %f\n",sol.err/data2, (float)misfit_fmp/nfm, total_misfit, misfit_pol_weight);
}
\end{verbatim}
\subsubsection*{Implement station reward factor}
Three reward factors are implemented:
\begin{verbatim}
	    // Implement station reward factor
	    // stn_rew = (float) (1.0 - ((2.0/pi)*atan(nda)))*5.0;
	    stn_rew = (exp(((float)-nda/7.0))*1.5)+0.5;
	    sol.err = stn_rew * sol.err;
\end{verbatim}

\subsubsection*{Compute VR}
\begin{verbatim}
            // Compute VR
            VR = 100.0 * (1 - (sol.err * sol.err));
\end{verbatim}

TO DO: Add a figure

\section{Adding reward factor \citep{Silwal2018}}

\begin{enumerate}
\item longer time-window for Pnl and surface waves
\item broader bandpass for Pnl and surface waves
\item usage of more stations
\end{enumerate}

\subsection{Reward for longer time-windows and broader bandpass}
The reward factor is applied alike to the body waves and the surface waves. Here is an example for the body wave:

\begin{description}
\item Pw = length of Pnl window (example: 5 seconds) 
\item Pband = Width of bandpass in Hz (example: 1- 10 Hz) 
\end{description}

\fbox{
\begin{minipage}{20em}
\eq
Pnl\_reward  = Pw \times Pband
\en
\end{minipage}
}

This is how its implemented in cap.c:
\begin{verbatim}
---------------------Line 327 (cap.c)---------------------------
// Compute reward factors
  pnl_reward = (x1*(f2_pnl-f1_pnl));
  sw_reward = (y1*(f2_sw-f1_sw));

---------------------Line 602 (cap.c)---------------------------
// multiply weights by reward factors
	// Add reward factor to each component
	if (j<3) {
	  spt->on_off = spt->on_off;
	  spt->rew = sw_reward;
	}
	else {
	  spt->on_off = spt->on_off;
	  spt->rew = pnl_reward;
	}

---------------------Line 700 (cap.c)---------------------------
        rec2 += spt->on_off*x2/(spt->npt * spt->rew);

---------------------Line 100 (sub_misfit.c)---------------------------
        x1 = x1/(spt->npt * spt->rew);

\end{verbatim}


\subsection{Reward when using more stations}
While fitting the data with the synthetics we frequently encounter a case where the total normalized misfit when using more data is larger than the one obtained when using fewer data. This happens because it is much easier to fit a single waveform (or waveforms for a single/few stations) and could easily be done using a wrong MT solution (\refFig{fig:wf_fits_1}). 

Also the variance reduction (VR) is not an actual representation of the `goodness' of the solution, since usually the VR decreases as we use more stations. In order to solve this issue we had to apply an exponential penalty function such that the fewer station inversions are penalized and the more data inversion is rewarded. 

(Functions tested here are saved in: cap/test\_station\_reward.m)

\eq
k = (\exp (-N/CONST)*1.5) + 0.5
\en 
where $k$ is the station penalty factor, $N$ is the number of stations, and $CONST$ defines the shape of the penalty curve (see \refFig{fig:Nstn_reward}). The shape of the curve ($CONST$) governs how severely the fewer station inversion needs to be penalized. An inverse exponential function scales between 0 and 1. For the test cases (\refFig{fig:wf_fits_1} and \refFig{fig:wf_fits_2}) it was soon observed that scaling needs to be done in a wider range in order to reasonably scale the misfit values across wider range of stations. However, the number 1.5 in the above equation could possibly be event dependent and maybe removed by combining with the $CONST$. An additional constant 0.5 was added at the end to prevent the misfit from going to zero in case of a large number of stations. 

Therefore the final scaled misfit is:
\eq
\Phi = k \times \Phi
\en


\fbox{
\begin{minipage}{35em}
Note: Other similar functions could also be used. I first started by using an inverse tangential function:
\eq
k = (1 - \frac{2}{\pi}*atan(N/CONST))
\en
But since this is just an ad-hoc function, using an inverse tangential makes things look more complicated.
\end{minipage}
}

\clearpage
%=================
\addcontentsline{toc}{section}{Bibliography}
\bibliographystyle{agu08}
\bibliography{carl_abbrev,carl_main,carl_him,carl_source,refs_vipul}
%=================

%\clearpage
\appendix

%-------------------------

\input{time_shifts_input}
\clearpage
\input{waveform_selection_input}

%===========================================================================================

% Figures
\begin{figure}
\includegraphics{cap_dur_2.eps}
\caption{Source duration vs magnitude relation used in CAP (red) and by GCMT (green). Using a wrong source duration can make a big difference in the magnitude estimate. (ADD A FIGURE TO SHOW THIS).
\label{fig:cap_dur}
}
\end{figure}

\begin{figure}
\includegraphics{Nstn_reward.eps}
\caption{Station reward factor}
\label{fig:Nstn_reward}
\end{figure}

\clearpage
\begin{figure}
\centering
\begin{tabular}{ccc}
polarity weight = 0.0 & polarity weight = 0.1 & polarity weight = 0.2  \\
\includegraphics[width=4cm]{20150727022154395_scak_016_beach_pol_wt_0p0.eps} &
\includegraphics[width=4cm]{20150727022154395_scak_016_beach_pol_wt_0p1.eps} &
\includegraphics[width=4cm]{20150727022154395_scak_016_beach_pol_wt_0p2.eps} \\
polarity weight = 0.3 & polarity weight = 0.4 & polarity weight = 0.5  \\
\includegraphics[width=4cm]{20150727022154395_scak_016_beach_pol_wt_0p3.eps} &
\includegraphics[width=4cm]{20150727022154395_scak_016_beach_pol_wt_0p4.eps} &
\includegraphics[width=4cm]{20150727022154395_scak_016_beach_pol_wt_0p5.eps} \\
polarity weight = 0.6 & polarity weight = 0.7 & polarity weight = 0.8  \\
\includegraphics[width=4cm]{20150727022154395_scak_016_beach_pol_wt_0p6.eps} &
\includegraphics[width=4cm]{20150727022154395_scak_016_beach_pol_wt_0p7.eps} &
\includegraphics[width=4cm]{20150727022154395_scak_016_beach_pol_wt_0p8.eps} \\
polarity weight = 0.9 & polarity weight = 1.0 &  \\
\includegraphics[width=4cm]{20150727022154395_scak_016_beach_pol_wt_0p9.eps} &
\includegraphics[width=4cm]{20150727022154395_scak_016_beach_pol_wt_1p0.eps} &\\
\end{tabular} 

\caption{
Effect of using different polarity weight factors. 
Marked in green are upward polarities, blue are downward polarities, and in red are mismatching polarities. Polarities are plotted at the lower-hemisphere piercing points on the beachball.
%(0.0 to 1.0 from left to right and top to bottom). 
Solution for polarity weight = 0.0 is obtained by minimizing waveform misfit only; solution for polarity weight = 1.0 is obtained using polarity only.
Poorer the quality of inversion, more drastic are the variability in beachball to the changes in weight factor.
%TO DO: Use a more dramatic example!
\label{fig:pol_weight}
}
\end{figure}


\begin{figure}
\includegraphics[width=17cm]{20090407201253480_scak_041_1.ps}
\includegraphics[width=17cm]{20090407201253480_scak_041_5.ps}
\caption{Waveform fits for CAP moment tensor solution when using 3 and 7 stations (top and bottom). Notice the increase in VR (also the decrease in the rms misfit) as we increase the number of stations. Also compare the moment tensor beachball with the actual solution in \refFig{fig:wf_fits_2}.
\label{fig:wf_fits_1}
}
\end{figure}

\begin{figure}
\includegraphics[width=17cm]{20090407201253480_scak_041_10.ps}
\caption{Waveform fits for the same solution as in \refFig{fig:wf_fits_2} when using 9 stations. 
\label{fig:wf_fits_2}
}
\end{figure}

%=================
\end{document}
